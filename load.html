<!doctype html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>/-> Maths Puzzle
        <-/</title>

            <script type="text/javascript" src="script/phaser.js"></script>
            <script type="text/javascript" src="script/soundmanager2.js"></script>

            <script>
                ///////////////////////////////////////////////////////////////////////
                // VARIABLES
                ///////////////////////////////////////////////////////////////////////

                //Count the number of shapes created
                var nbF1 = 0;
                var nbF2 = 0;
                var nbF3 = 0;
                var nbF4 = 0;
                var nbF5 = 0;
                var nbF6 = 0;
                var nbF = 0;

                //Surface des formes

                var areaSquare = 10000;
                var areaTriangle = 4330.12701892;
                var areaTrapeze = 3 * 4330.12701892;
                var areaHexagon = 6 * 4330.12701892;
                var areaPattern = 0;
                var aireSolution = 0;

                //Edition mode testing
                var test = 0;

                //Groups of shapes 
                var F1;
                var F2;
                var F3;
                var F4;
                var F5;
                var F6;

                var P1;
                var P2;
                var P3;
                var P4;
                var P5;
                var P6;

                //Test the end of the game
                var end = 0;

                //Do not receive double success message
                var nbAlert = 0;

                // Initialisation of the binary quantum matrix for the shapes

                //Square
                var mat_square = new Array(65);
                for (var i = 0; i < 65; i++) {
                    mat_square[i] = new Array(65);
                }
                for (var i = 0; i < 65; i++) {
                    for (var j = 0; j < 65; j++) {
                        mat_square[i][j] = 1;
                    }
                }

                //Trapeze
                var mat_trapeze = new Array(200);
                for (var i = 0; i < 200; i++) {
                    mat_trapeze[i] = new Array(100);
                }
                for (var i = 0; i < 200; i++) {
                    for (var j = 0; j < 100; j++) {
                        mat_trapeze[i][j] = 1;
                    }
                }
                var J = 98;
                for (var i = 0; i < 49; i++) {
                    for (var j = 0; j < J; j++) {
                        mat_trapeze[i][j] = 0;
                    }
                    J = J - 2;
                }
                var J = 98;
                for (var i = 199; i > 149; i--) {
                    for (var j = 0; j < J; j++) {
                        mat_trapeze[i][j] = 0;
                    }
                    J = J - 2;
                }

                //Hexagone
                var mat_hexagon = new Array(200);
                for (var i = 0; i < 200; i++) {
                    mat_hexagon[i] = new Array(200);
                }
                for (var i = 0; i < 200; i++) {
                    for (var j = 0; j < 200; j++) {
                        mat_hexagon[i][j] = 1;
                    }
                }
                var J = 98;
                for (var i = 0; i < 49; i++) {
                    for (var j = 0; j < J; j++) {
                        mat_hexagon[i][j] = 0;
                    }
                    J = J - 2;
                }
                var J = 98;
                for (var i = 199; i > 149; i--) {
                    for (var j = 0; j < J; j++) {
                        mat_hexagon[i][j] = 0;
                    }
                    J = J - 2;
                }
                var J = 101;
                for (var i = 0; i < 49; i++) {
                    for (var j = J; j < 200; j++) {
                        mat_hexagon[i][j] = 0;
                    }
                    J = J + 2;
                }
                var J = 101;
                for (var i = 199; i > 149; i--) {
                    for (var j = J; j < 200; j++) {
                        mat_hexagon[i][j] = 0;
                    }
                    J = J + 2;
                }

                //Triangle
                var mat_triangle_equi = new Array(100);
                for (var i = 0; i < 100; i++) {
                    mat_triangle_equi[i] = new Array(100);
                }
                for (var i = 0; i < 100; i++) {
                    for (var j = 0; j < 100; j++) {
                        mat_triangle_equi[i][j] = 1;
                    }
                }
                var J = 98;
                for (var i = 0; i < 49; i++) {
                    for (var j = 0; j < J; j++) {
                        mat_triangle_equi[i][j] = 0;
                    }
                    J = J - 2;
                }
                var J = 98;
                for (var i = 99; i > 50; i--) {
                    for (var j = 0; j < J; j++) {
                        mat_triangle_equi[i][j] = 0;
                    }
                    J = J - 2;
                }


                //Initialisation of the problem's and the solution's matrix

                var matPatron = new Array(1200);
                for (var i = 0; i < 1200; i++) {
                    matPatron[i] = new Array(800);
                }
                for (var i = 0; i < 1200; i++) {
                    for (var j = 0; j < 800; j++) {
                        matPatron[i][j] = 0;
                    }
                }

                var matSolution = new Array(1200);
                for (var i = 0; i < 1200; i++) {
                    matSolution[i] = new Array(800);
                }
                for (var i = 0; i < 1200; i++) {
                    for (var j = 0; j < 800; j++) {
                        matSolution[i][j] = 0;
                    }
                }

                // Grandient background
                var myBitmap;
                var grd;
                var rot;
                var col;
                var mute;
                var ret;
                var exp;
                var palette;
                var pipe;
                var basketLeft;
                var basketMiddle;
                var basketRight;
                var menuRight;
                var menuMiddle;
                var menuLeft;


                //////////////////////////////////////////////////////////////////////////////////////////////////

                function start() {

                    //Create a new Phaser JS game
                    var game = new Phaser.Game("100%", "100%", Phaser.CANVAS, 'pgrou', {
                        //var game = new Phaser.Game(window.innerWidth * window.devicePixelRatio, window.innerHeight * window.devicePixelRatio, Phaser.CANVAS, 'pgrou', { 
                        //var game = new Phaser.Game(2000, 1000, Phaser.CANVAS, 'pgrou', { 
                        preload: preload,
                        create: create,
                        update: update,
                        render: render
                    });

                    // Language Definition
                    var language = "assets/audio/fr/";

                    //Load the necessary files before the beginning of the game
                    function preload() {
                        game.load.text('txt_hexagon', 'assets/sprites/hexagon.txt');
                        game.load.text('txt_diamond', 'assets/sprites/diamond.txt');
                        game.load.text('txt_square', 'assets/sprites/square.txt');
                        game.load.text('txt_trapeze', 'assets/sprites/trapeze.txt');
                        game.load.text('txt_triangle_equi', 'assets/sprites/triangle-equi.txt');
                        game.load.text('txt_triangle_rect', 'assets/sprites/triangle-rect.txt');

                        game.load.image('img_hexagon', 'assets/sprites/hexagon.png');
                        game.load.image('img_diamond', 'assets/sprites/diamond.png');
                        game.load.image('img_square', 'assets/sprites/square.png');
                        game.load.image('img_trapeze', 'assets/sprites/trapeze.png');
                        game.load.image('img_triangle_equi', 'assets/sprites/triangle-equi.png');
                        game.load.image('img_triangle_rect', 'assets/sprites/triangle-rect.png');

                        game.load.image('store', 'assets/images/menu/store.png');
                        game.load.image('pipe', 'assets/images/menu/store-pipe.png');

                        game.load.spritesheet('trashbin', 'assets/images/buttons/trashbin.png', 83, 76);

                        game.load.spritesheet('button-square', 'assets/images/buttons/shape-square.png', 78, 77);
                        game.load.spritesheet('button-trapeze', 'assets/images/buttons/shape-trapeze.png', 78, 77);
                        game.load.spritesheet('button-triangle-equi', 'assets/images/buttons/shape-t-equi.png', 78, 77);
                        game.load.spritesheet('button-hexagon', 'assets/images/buttons/shape-hexagon.png', 78, 77);
                        game.load.spritesheet('button-triangle-rect', 'assets/images/buttons/shape-t-rect.png', 78, 77);
                        game.load.spritesheet('button-diamond', 'assets/images/buttons/shape-diamond.png', 78, 77);

                        game.load.image('basket-left', 'assets/images/menu/basket-left.png');
                        game.load.image('basket-right', 'assets/images/menu/basket-right.png');
                        game.load.image('basket-middle', 'assets/images/menu/basket-middle.png');

                        game.load.spritesheet('button-rotate', 'assets/images/buttons/option-rotate.png', 48, 48);
                        game.load.spritesheet('button-colors', 'assets/images/buttons/option-colors.png', 48, 48);
                        game.load.spritesheet('button-home', 'assets/images/buttons/option-home.png', 48, 48);
                        game.load.spritesheet('button-export', 'assets/images/buttons/option-export.png', 48, 48);
                        game.load.spritesheet('button-mute', 'assets/images/buttons/option-mute.png', 48, 48);

                        game.load.image('menu-left', 'assets/images/menu/menu-left.png');
                        game.load.image('menu-right', 'assets/images/menu/menu-right.png');
                        game.load.image('menu-middle', 'assets/images/menu/menu-middle.png');

                        game.load.audio('trashbin', language + 'trashbin.mp3');
                        /*
                        game.load.audio('click',language+'click.mp3');
                        game.load.audio('rotation',language+'rotation.mp3');
                        game.load.audio('index',language+'index.mp3');
                        game.load.audio('select_class',language+'select_class.mp3');
                        game.load.audio('lock',language+'lock.mp3');
                        game.load.audio('import',language+'import.mp3');
                        game.load.audio('classic',language+'classic.mp3');
                        game.load.audio('firstform',language+'firstform.mp3');
                        game.load.audio('matching_cla',language+'matching_cla.mp3');
                        game.load.audio('problem',language+'problem.mp3');
                        game.load.audio('distrib',language+'distrib.mp3');
                        game.load.audio('prop_rotation',language+'prop_rotation.mp3');
                        game.load.audio('top_validation',language+'top_validation.mp3');
                        game.load.audio('low_validation',language+'low_validation.mp3');
                        game.load.audio('popup',language+'popup.mp3');
                        game.load.audio('nextlevel',language+'nextlevel.mp3');
                        game.load.audio('square1',language+'square1.mp3');
                        game.load.audio('triangle-eq1',language+'triangle-eq1.mp3');
                        game.load.audio('triangle-req1',language+'triangle-req1.mp3');
                        game.load.audio('trapeze1',language+'trapeze1.mp3');
                        game.load.audio('diamond1',language+'diamond1.mp3');
                        game.load.audio('selectfree',language+'selectfree.mp3');
                        game.load.audio('matching-free',language+'matching-free.mp3');
                        game.load.audio('crea',language+'crea.mp3');
                        game.load.audio('save',language+'save.mp3');
                        game.load.audio('advertise',language+'advertise.mp3');
                        game.load.audio('print',language+'print.mp3');
                        game.load.audio('exprt',language+'exprt.mp3');
                        */
                    }



                    //Main function
                    function create() {

                        game.scale.scaleMode = Phaser.ScaleManager.RESIZE;

                        //Wallpaper
                        myBitmap = game.make.bitmapData(2000, 2000);
                        myBitmap.addToWorld();
                        grd = myBitmap.context.createLinearGradient(0, 0, 1000, 1000);
                        grd.addColorStop(0, "#66d1f9");
                        grd.addColorStop(1, "#bce3f0");
                        myBitmap.context.fillStyle = grd;
                        myBitmap.context.fillRect(0, 0, 2000, 2000);

                        //game.stage.backgroundColor = "#4488AA";
                        palette = ["0x83EE00", "0xFBFE00", "0x058AB6", "0xE4005C", "0x8007BE", "0xFF8300"];


                        //Heritage Relationships
                        F1 = game.add.group();
                        F2 = game.add.group();
                        F3 = game.add.group();
                        F4 = game.add.group();
                        F5 = game.add.group();
                        F6 = game.add.group();

                        P1 = game.add.group();
                        P2 = game.add.group();
                        P3 = game.add.group();
                        P4 = game.add.group();
                        P5 = game.add.group();
                        P6 = game.add.group();

                        formes = game.add.group();
                        patrons = game.add.group();
                        poubelle = game.add.group();

                        formes.add(F1);
                        formes.add(F2);
                        formes.add(F3);
                        formes.add(F4);
                        formes.add(F5);
                        formes.add(F6);

                        patrons.add(P1);
                        patrons.add(P2);
                        patrons.add(P3);
                        patrons.add(P4);
                        patrons.add(P5);
                        patrons.add(P6);

                        // Store Creation
                        var bin = game.add.button(60, 20, 'trashbin', null, this, 2, 1, 0, 1);
                        trash.add(bin);
                        var store = game.add.sprite(5, 5, 'store');
                        store.scaleMax = 1;
                        store.scaleMin = 1;
                        pipe = game.add.sprite(5, 395, 'pipe');
                        pipe.height = window.innerHeight - (390 + 212);
                        var buttonSquare = game.add.button(20, 110, 'button-square', addForm1, this, 2, 1, 0, 1);
                        var buttonTrapezoid = game.add.button(100, 110, 'button-trapeze', addForm2, this, 2, 1, 0, 1);
                        var buttonTriangleEqui = game.add.button(20, 200, 'button-triangle-equi', addForm4, this, 2, 1, 0, 1);
                        var buttonHexagon = game.add.button(100, 200, 'button-hexagon', addForm3, this, 2, 1, 0, 1);
                        var buttonTriangleRect = game.add.button(20, 290, 'button-triangle-rect', addForm5, this, 2, 1, 0, 1);
                        var buttonDiamond = game.add.button(100, 290, 'button-diamond', addForm6, this, 2, 1, 0, 1);

                        // Basket creation
                        basketLeft = game.add.sprite(5, window.innerHeight - 212 - 5, 'basket-left');
                        basketMiddle = game.add.sprite(142, window.innerHeight - 212 - 5, 'basket-middle');
                        basketMiddle.width = window.innerWidth - 2 * 142;
                        basketRight = game.add.sprite(window.innerWidth - 142 - 5, window.innerHeight - 212 - 5, 'basket-right');

                        // Menu construction
                        var long = 100;
                        menuLeft = game.add.sprite(window.innerWidth - 5 - long - 2 * 35, 5, 'menu-left');
                        menuMiddle = game.add.sprite(window.innerWidth - 5 - long - 35, 5, 'menu-middle');
                        menuMiddle.width = long;
                        menuRight = game.add.sprite(window.innerWidth - 35 - 5, 5, 'menu-right');

                        //Add rotation and color buttons
                        rot = game.add.button(10, window.innerHeight - 210, 'button-rotate', rotationButton, this, 2, 1, 0, 1);
                        col = game.add.button(58, window.innerHeight - 210, 'button-colors', colorButton, this, 2, 1, 0, 1);
                        ret = game.add.button(window.innerWidth - (18 + 3 * 50), 10, 'button-home', returnIndex, this, 2, 1, 0, 1);
                        mute = game.add.button(window.innerWidth - (18 + 2 * 50), 10, 'button-mute', null, this, 2, 1, 0, 1);
                        exp = game.add.button(window.innerWidth - (18 + 1 * 50), 10, 'button-export', exportProblem, this, 2, 1, 0, 1);


                        //Funtion to return to the index
                        function returnIndex() {
                            self.location.href = 'index.html';
                        }

                        //Create the wished pattern

                        var pattern = [];

                        //Get the JSON content
                        var result = document.getElementById('cache').innerText;
                        document.getElementById('json').style.display = 'none';

                        //JSON analysis
                        var jsonObj = JSON.parse(result);

                        //Pattern creation
                        for (var i = 0; i < jsonObj.problem.pattern.length; i++) {
                            switch (jsonObj.problem.pattern[i].kind) {
                                case "square":
                                    pattern[i] = P1.create(jsonObj.problem.pattern[i].anchorPoint.x, jsonObj.problem.pattern[i].anchorPoint.y, 'img_square');
                                    pattern[i].inputEnabled = true;
                                    pattern[i].tint = 0x020303;
                                    pattern[i].angle = jsonObj.problem.pattern[i].rotation;
                                    pattern[i].alpha = 0.4;
                                    break;
                                case "trapeze":
                                    pattern[i] = P2.create(jsonObj.problem.pattern[i].anchorPoint.x, jsonObj.problem.pattern[i].anchorPoint.y, 'img_trapeze');
                                    pattern[i].inputEnabled = true;
                                    pattern[i].tint = 0x020303;
                                    pattern[i].angle = jsonObj.problem.pattern[i].rotation;
                                    pattern[i].alpha = 0.4;
                                    break;
                                case "hexagon":
                                    pattern[i] = P3.create(jsonObj.problem.pattern[i].anchorPoint.x, jsonObj.problem.pattern[i].anchorPoint.y, 'img_hexagon');
                                    pattern[i].inputEnabled = true;
                                    pattern[i].tint = 0x020303;
                                    pattern[i].angle = jsonObj.problem.pattern[i].rotation;
                                    pattern[i].alpha = 0.4;
                                    break;
                                case "triangleEqui":
                                    pattern[i] = P4.create(jsonObj.problem.pattern[i].anchorPoint.x, jsonObj.problem.pattern[i].anchorPoint.y, 'img_triangle_equi');
                                    pattern[i].inputEnabled = true;
                                    pattern[i].tint = 0x020303;
                                    pattern[i].angle = jsonObj.problem.pattern[i].rotation;
                                    pattern[i].alpha = 0.4;
                                    break;
                                case "triangleRect":
                                    pattern[i] = P5.create(jsonObj.problem.pattern[i].anchorPoint.x, jsonObj.problem.pattern[i].anchorPoint.y, 'img_triangle_rect');
                                    pattern[i].inputEnabled = true;
                                    pattern[i].tint = 0x020303;
                                    pattern[i].angle = jsonObj.problem.pattern[i].rotation;
                                    pattern[i].alpha = 0.4;
                                    break;
                                case "diamond":
                                    pattern[i] = P6.create(jsonObj.problem.pattern[i].anchorPoint.x, jsonObj.problem.pattern[i].anchorPoint.y, 'img_diamond');
                                    pattern[i].inputEnabled = true;
                                    pattern[i].tint = 0x020303;
                                    pattern[i].angle = jsonObj.problem.pattern[i].rotation;
                                    pattern[i].alpha = 0.4;
                                    break;

                            }
                        }


                        //Update the pattern matrix with the shapes' matrix
                        P1.forEach(function(patternItem) {
                            areaPattern = areaPattern + areaSquare;
                            for (var i = 0; i < mat_square.length; i++) {
                                for (var j = 0; j < mat_square[0].length; j++) {
                                    if (mat_square[i][j] == 1) {
                                        matPattern[Math.floor(patternItem.y + i)][Math.floor(patternItem.x + j)] = 1;
                                        // i is the line index --> coord y
                                        // j is the column index --> coord x
                                    }
                                }
                            }

                        }, this);

                        P2.forEach(function(patternItem) {
                            areaPattern = areaPattern + areaTrapeze;
                            for (var i = 0; i < mat_trapeze.length; i++) {
                                for (var j = 0; j < mat_trapeze[0].length; j++) {
                                    if (mat_trapeze[i][j] == 1) {
                                        matPattern[Math.floor(patternItem.y + i)][Math.floor(patternItem.x + j)] = 1;
                                    }
                                }
                            }

                        }, this);

                        P3.forEach(function(patternItem) {
                            areaPattern = areaPattern + areaHexagon;
                            for (var i = 0; i < mat_hexagon.length; i++) {
                                for (var j = 0; j < mat_hexagon[0].length; j++) {
                                    if (mat_hexagon[i][j] == 1) {
                                        matPattern[Math.floor(patternItem.y + i)][Math.floor(patternItem.x + j)] = 1;
                                    }
                                }
                            }

                        }, this);

                        P4.forEach(function(patternItem) {
                            areaPattern = areaPattern + areaTriangleEqui;
                            for (var i = 0; i < mat_triangle_equi.length; i++) {
                                for (var j = 0; j < mat_triangle_equi[0].length; j++) {
                                    if (mat_triangle_equi[i][j] == 1) {
                                        matPattern[Math.floor(patternItem.y + i)][Math.floor(patternItem.x + j)] = 1;
                                    }
                                }
                            }

                        }, this);

                        P5.forEach(function(patternItem) {
                            areaPattern = areaPattern + areaTriangleRect;
                            for (var i = 0; i < mat_triangle_rect.length; i++) {
                                for (var j = 0; j < mat_triangle_rect[0].length; j++) {
                                    if (mat_triangle_rect[i][j] == 1) {
                                        matPattern[Math.floor(patternItem.y + i)][Math.floor(patternItem.x + j)] = 1;
                                    }
                                }
                            }

                        }, this);

                        P6.forEach(function(patternItem) {
                            areaPattern = areaPattern + areaDiamond;
                            for (var i = 0; i < mat_diamond.length; i++) {
                                for (var j = 0; j < mat_diamond[0].length; j++) {
                                    if (mat_diamond[i][j] == 1) {
                                        matPattern[Math.floor(patternItem.y + i)][Math.floor(patternItem.x + j)] = 1;
                                    }
                                }
                            }

                        }, this);

                    }

                    //Function to add shapes from the basket
                    function addShape(shape, F) {
                        nbF = nbF + 1;
                        var tempSprite = F.create(130 * nbF - 35, game.height - 90, 'img_' + shape);
                        tempSprite.anchor.x = 0.5;
                        tempSprite.anchor.y = 0.5;

                        //tempSprite.tint = Math.random() * 0xffffff;
                        //tempSprite.tint= palette[Math.floor(Math.random() * palette.length)];
                        //tempSprite.tint = 0xabdcf1;

                        tempSprite.inputEnabled = true; //Active Input
                        tempSprite.input.enableDrag(false, true); //Mobile (drag)
                        tempSprite.input.enableSnap(10, 10, false, true); //Quantisation of 10 pixels
                        tempSprite.events.onInputDown.add(formInteraction, this); //Edition mode after click
                        tempSprite.events.onDragStop.add(endDrag, this); //End of drag
                    }

                    function addForm1(form1, pointer) {
                        nbF1 = nbF1 + 1;
                        addShape('square', F1);
                    }

                    function addForm2(form2, pointer) {
                        nbF2 = nbF2 + 1;
                        addShape('trapeze', F2);
                    }

                    function addForm3(form3, pointer) {
                        nbF3 = nbF3 + 1;
                        addShape('hexagon', F3);
                    }

                    function addForm4(form4, pointer) {
                        nbF4 = nbF4 + 1;
                        addShape('triangle_equi', F4);
                    }

                    function addForm5(form5, pointer) {
                        nbF5 = nbF5 + 1;
                        addShape('triangle_rect', F5);
                    }

                    function addForm6(form6, pointer) {
                        nbF6 = nbF6 + 1;
                        addShape('diamond', F6);
                    }

                    //Edition Modes (colors and rotation)
                    function formInteraction(tempSprite, pointer) {
                        switch (test) {
                            case 0:
                                break;
                            case 1:
                                tempSprite.angle += 45;
                                break;
                            case 2:
                                var rand = Math.floor((Math.random() * 5));
                                tempSprite.tint = palette[Math.floor(Math.random() * palette.length)];
                                break;
                        }
                    }

                    //Activation of the rotation button
                    function rotationButton(rot, pointer) {
                        switch (test) {
                            case 0:
                                test = 1;
                                rot.setFrames(3, 0, 1, 0);
                                break;
                            case 1:
                                test = 0;
                                rot.setFrames(2, 1, 0, 1);
                                break;
                            case 2:
                                test = 1;
                                rot.setFrames(3, 0, 1, 0);
                                col.setFrames(2, 1, 0, 1);
                                break;
                        }
                    }

                    // Change color
                    function colorButton(col, pointer) {
                        switch (test) {
                            case 0:
                                test = 2;
                                col.setFrames(3, 0, 1, 0);
                                break;
                            case 1:
                                test = 2;
                                rot.setFrames(2, 1, 0, 1);
                                col.setFrames(3, 0, 1, 0);
                                break;
                            case 2:
                                test = 0;
                                col.setFrames(2, 1, 0, 1);
                                break;
                        }
                    }

                    //Function at the end of the drag
                    function endDrag(tempSprite, pointer) {

                        if ((game.input.y > 20) && (game.input.y < 96) && (game.input.x > 60) && (game.input.x < 143)) {
                            if (tempSprite.key == 'img_square') {
                                nbF1 = nbF1 - 1;
                            }
                            if (tempSprite.key == 'img_trapeze') {
                                nbF2 = nbF2 - 1;
                            }
                            if (tempSprite.key == 'img_hexagon') {
                                nbF3 = nbF3 - 1;
                            }
                            if (tempSprite.key == 'img_triangle_equi') {
                                nbF4 = nbF4 - 1;
                            }
                            if (tempSprite.key === 'img_triangle_rect') {
                                nbF5 = nbF5 - 1;
                            }
                            if (tempSprite.key === 'img_diamond') {
                                nbF6 = nbF6 - 1;
                            }
                            tempSprite.destroy();
                        }

                        for (var i = 0; i < 1200; i++) {
                            for (var j = 0; j < 800; j++) {
                                matSolution[i][j] = 0;
                            }
                        }

                        areaSolution = 0;

                        F1.forEach(function(patternItem) {
                            areaSolution = areaSolution + areaSquare;
                            for (var i = 0; i < mat_square.length; i++) {
                                for (var j = 0; j < mat_square[0].length; j++) {
                                    if (mat_square[i][j] == 1) {
                                        matSolution[Math.floor(patternItem.y + i * Math.cos(patternItem.angle * 2 * 3.14159 / 360) - j * Math.sin(patternItem.angle * 2 * 3.14159 / 360))][Math.floor(patternItem.x + i * Math.sin(patternItem.angle * 2 * 3.14159 / 360) + j * Math.cos(patternItem.angle * 2 * 3.14159 / 360))] = 1;
                                    }
                                }
                            }

                        }, this);

                        F2.forEach(function(patternItem) {
                            areaSolution = areaSolution + areaTrapeze;
                            for (var i = 0; i < mat_trapeze.length; i++) {
                                for (var j = 0; j < mat_trapeze[0].length; j++) {
                                    if (mat_trapeze[i][j] == 1) {
                                        matSolution[Math.floor(patternItem.y + i * Math.cos(patternItem.angle * 2 * 3.14159 / 360) - j * Math.sin(patternItem.angle * 2 * 3.14159 / 360))][Math.floor(patternItem.x + i * Math.sin(patternItem.angle * 2 * 3.14159 / 360) + j * Math.cos(patternItem.angle * 2 * 3.14159 / 360))] = 1;
                                    }
                                }
                            }

                        }, this);

                        F3.forEach(function(patternItem) {
                            areaSolution = areaSolution + areaHexagon;
                            for (var i = 0; i < mat_hexagon.length; i++) {
                                for (var j = 0; j < mat_hexagon[0].length; j++) {
                                    if (mat_hexagon[i][j] == 1) {
                                        matSolution[Math.floor(patternItem.y + i * Math.cos(patternItem.angle * 2 * 3.14159 / 360) - j * Math.sin(patternItem.angle * 2 * 3.14159 / 360))][Math.floor(patternItem.x + i * Math.sin(patternItem.angle * 2 * 3.14159 / 360) + j * Math.cos(patternItem.angle * 2 * 3.14159 / 360))] = 1;
                                    }
                                }
                            }

                        }, this);

                        F4.forEach(function(patternItem) {
                            areaSolution = areaSolution + areaTriangleEqui;
                            for (var i = 0; i < mat_triangle_equi.length; i++) {
                                for (var j = 0; j < mat_triangle_equi[0].length; j++) {
                                    if (mat_triangle_equi[i][j] == 1) {
                                        matSolution[Math.floor(patternItem.y + i * Math.cos(patternItem.angle * 2 * 3.14159 / 360) - j * Math.sin(patternItem.angle * 2 * 3.14159 / 360))][Math.floor(patternItem.x + i * Math.sin(patternItem.angle * 2 * 3.14159 / 360) + j * Math.cos(patternItem.angle * 2 * 3.14159 / 360))] = 1;
                                    }
                                }
                            }

                        }, this);

                        F5.forEach(function(patternItem) {
                            areaSolution = areaSolution + areaTriangleRect;
                            for (var i = 0; i < mat_triangle_rect.length; i++) {
                                for (var j = 0; j < mat_triangle_rect[0].length; j++) {
                                    if (mat_triangle_rect[i][j] == 1) {
                                        matSolution[Math.floor(patternItem.y + i * Math.cos(patternItem.angle * 2 * 3.14159 / 360) - j * Math.sin(patternItem.angle * 2 * 3.14159 / 360))][Math.floor(patternItem.x + i * Math.sin(patternItem.angle * 2 * 3.14159 / 360) + j * Math.cos(patternItem.angle * 2 * 3.14159 / 360))] = 1;
                                    }
                                }
                            }

                        }, this);

                        F6.forEach(function(patternItem) {
                            areaSolution = areaSolution + areaDiamond;
                            for (var i = 0; i < mat_diamond.length; i++) {
                                for (var j = 0; j < mat_diamond[0].length; j++) {
                                    if (mat_diamond[i][j] == 1) {
                                        matSolution[Math.floor(patternItem.y + i * Math.cos(patternItem.angle * 2 * 3.14159 / 360) - j * Math.sin(patternItem.angle * 2 * 3.14159 / 360))][Math.floor(patternItem.x + i * Math.sin(patternItem.angle * 2 * 3.14159 / 360) + j * Math.cos(patternItem.angle * 2 * 3.14159 / 360))] = 1;
                                    }
                                }
                            }

                        }, this);

                    }

                    var valid = 0;

                    //Update function that is always running on the background
                    function update() {
                        //Bring the forms up
                        game.world.bringToTop(forms);
                        game.world.bringToTop(trash);

                        // Adapt the size of the interface to the screen
                        pipe.height = window.innerHeight - (390 + 212);
                        basketLeft.y = window.innerHeight - 212 - 5;
                        basketMiddle.y = window.innerHeight - 212 - 5;
                        basketMiddle.width = window.innerWidth - 2 * 142;
                        basketRight.x = window.innerWidth - 142 - 5;
                        basketRight.y = window.innerHeight - 212 - 5;

                        var long = 100;

                        menuLeft.x = window.innerWidth - 5 - long - 2 * 35;
                        menuMiddle.x = window.innerWidth - 5 - long - 35;
                        menuMiddle.width = long;
                        menuRight.x = window.innerWidth - 35 - 5;

                        rot.y = window.innerHeight - 210;
                        col.y = window.innerHeight - 210;
                        ret.x = window.innerWidth - (18 + 3 * 50);
                        mute.x = window.innerWidth - (18 + 2 * 50);
                        exp.x = window.innerWidth - (18 + 1 * 50);


                        // Vérification de la solution    
                        valid = 0;

                        for (var i = 0; i < 1200; i++) {
                            for (var j = 0; j < 800; j++) {
                                if (matSolution[i][j] != matPattern[i][j]) {
                                    valid++;
                                }
                            }
                        }

                        if (valid < 500 && areaSolution == areaPattern) {
                            fin = 1;
                            if (nbAlert == 0) {
                                nbAlert = 1;
                                var delay = 500;
                                setTimeout(function() {
                                    alert("Bravo! Vous avez réussi ce niveau!");
                                }, delay);
                            }
                        }

                    }

                    //Debugging Mode
                    function render() {
                        game.debug.style = '#fff';
                        game.debug.text('Squares : ' + nbF1, 16, 48);
                        game.debug.text('Trapezes : ' + nbF2, 16, 60);
                        game.debug.text('Hexagons : ' + nbF3, 16, 72);
                        game.debug.text('Triangles : ' + nbF4, 16, 84);
                        game.debug.text('Rect Triangles : ' + nbF5, 16, 96);
                        game.debug.text('Diamonds : ' + nbF6, 16, 108);
                        game.debug.text('Function : ' + test, 16, 120);
                        //game.debug.text('End : ' + end, 16, 108);
                        //game.debug.text('Solution Area: ' + areaSolution, 16, 120);
                        //game.debug.text('Problem Area: ' + areaPattern, 16, 132);
                        //game.debug.text('matProblem : ' + matPattern[180][22], 16, 120);
                        //game.debug.text('MatSolution : ' + matSolution[180][22], 16, 132);
                        //game.debug.inputInfo(16, 144);
                    }
                }

                /////////////////////////////////////////////////////////////

                //Function to verify the extension 
                function checkExtension() {
                    var fileInput = document.getElementById('fileInput');
                    var myString = fileInput.value;
                    var myExt = myString.substring(myString.lastIndexOf(".") + 1, myString.length);
                    myExt = myExt.toLowerCase();

                    //Error message if it is not a JSON
                    if (myExt !== "json") {
                        alert("Your file does not have the right format. Please, choose a JSON file.");
                    } else {
                        //If it is good, we launch the game
                        start();
                    }
                }


                //Load JSON file
                window.onload = function() {
                    var fileInput = document.getElementById('fileInput');

                    //On récupère le contenu du json qu'on passe en champ caché dans la div "cache"
                    var fileCache = document.getElementById('cache');
                    fileInput.addEventListener('change', function(e) {

                            var file = fileInput.files[0];
                            var reader = new FileReader();
                            reader.onload = function(e) {

                                var jsonObj = reader.result;
                                fileCache.innerHTML = jsonObj;
                            };
                            reader.readAsText(file);
                        }


                    );

                    ;
                };
            </script>
            <style type="text/css">
                body {
                    margin: 0;
                }
                .cache {
                    position: absolute;
                    display: none;
                }
                #json {
                    margin-left: 500px;
                    margin-top: 200px;
                }
                #start {
                    padding: 6px 0 6px 0;
                    font: Bold 13px Arial;
                    background: #5FB404;
                    color: white;
                    width: 100px;
                    border-radius: 2px;
                    border: none;
                }
            </style>
</head>

<body>

    <div id="json">
        <input type="file" id="fileInput" name="fileInput">
        <br>
        <br>
        <input type="button" id="start" value="C'est parti !" onclick="checkExtension();">
    </div>

    <h3 class="cache" id="cache"> </h3>


</body>

</html>