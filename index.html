<!doctype html> 
<html lang="fr"> 
<head> 
	<meta charset="UTF-8" />
	<title>/-> AttriMaths <-/</title>
	<script type="text/javascript" src="phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

//Création d'un nouveau jeu Phaser JS
var game = new Phaser.Game("100%", "100%", Phaser.CANVAS, 'pgrou', { preload: preload, create: create, update: update, render: render });

//Charger en mémoire les images nécessaires avant le démarrage du jeu
function preload() {

    game.load.image('carre', 'sprites/carre.png');
    game.load.image('hexagone', 'sprites/hexagone.png');
    game.load.image('trapeze', 'sprites/trapeze.png');
    game.load.image('triangle', 'sprites/triangle.png');
    
    game.load.image('rotation', 'images/rotation.png');
    game.load.image('poubelle', 'images/poubelle.png');

}

//Compteurs de formes crées
var nbF1 = 0;
var nbF2 = 0;
var nbF3 = 0;
var nbF4 = 0;

//Test du mode d'édition dans une partie
var test = 0;


//Variables de groupes de formes et patrons
var F1;
var F2;
var F3;
var F4;

var P1;
var P2;
var P3;
var P4;


//Tester la fin de la partie
var fin = 0;

//Ne pas recevoir un message de fin doublé
var nbAlert = 0;

//Initialisation des matrices de quantisation pour les formes élémentaires

//Carré
var mat1 = new Array(100);
for (var i = 0; i < 100; i++) {
    mat1[i] = new Array(100);
}
for (var i = 0; i < 100; i++) {
    for (var j = 0; j < 100; j++) {
        mat1[i][j] = 1;
    }
}

//Trapeze
var mat2 = new Array(200);
for (var i = 0; i < 200; i++) {
    mat2[i] = new Array(100);
}
for (var i = 0; i < 200; i++) {
    for (var j = 0; j < 100; j++) {
        mat2[i][j] = 1;
    }
}
var J=98;
for (var i = 0; i < 49; i++) {
    for (var j = 0; j < J; j++) {
        mat2[i][j] = 0;
    }
    J=J-2;
}
var J=98;
for (var i = 199; i > 149; i--) {
    for (var j = 0; j < J; j++) {
        mat2[i][j] = 0;
    }
    J=J-2;
}

//Hexagone
var mat3 = new Array(200);
for (var i = 0; i < 200; i++) {
    mat3[i] = new Array(200);
}
for (var i = 0; i < 200; i++) {
    for (var j = 0; j < 200; j++) {
        mat3[i][j] = 1;
    }
}
var J=98;
for (var i = 0; i < 49; i++) {
    for (var j = 0; j < J; j++) {
        mat3[i][j] = 0;
    }
    J=J-2;
}
var J=98;
for (var i = 199; i > 149; i--) {
    for (var j = 0; j < J; j++) {
        mat3[i][j] = 0;
    }
    J=J-2;
}
var J=101;
for (var i = 0; i < 49; i++) {
    for (var j = J; j < 200; j++) {
        mat3[i][j] = 0;
    }
    J=J+2;
}
var J=101;
for (var i = 199; i > 149; i--) {
    for (var j = J; j < 200; j++) {
        mat3[i][j] = 0;
    }
    J=J+2;
}

//Triangle
var mat4 = new Array(100);
for (var i = 0; i < 100; i++) {
    mat4[i] = new Array(100);
}
for (var i = 0; i < 100; i++) {
    for (var j = 0; j < 100; j++) {
        mat4[i][j] = 1;
    }
}
var J=98;
for (var i = 0; i < 49; i++) {
    for (var j = 0; j < J; j++) {
        mat4[i][j] = 0;
    }
    J=J-2;
}
var J=98;
for (var i = 99; i > 50; i--) {
    for (var j = 0; j < J; j++) {
        mat4[i][j] = 0;
    }
    J=J-2;
}

//Initialisation des matrices de quantisation des positions du problème (patron) et la solution proposée

var matPatron = new Array(1200);
for (var i = 0; i < 1200; i++) {
    matPatron[i] = new Array(400);
}
for (var i = 0; i < 1200; i++) {
    for (var j = 0; j < 400; j++) {
        matPatron[i][j] = 0;
    }
}

var matSolution = new Array(1200);
for (var i = 0; i < 1200; i++) {
    matSolution[i] = new Array(400);
}
for (var i = 0; i < 1200; i++) {
    for (var j = 0; j < 400; j++) {
        matSolution[i][j] = 0;
    }
}

//Fonction Create principale du jeu
function create() {
    //Fond d'écran
    game.stage.backgroundColor = "#4488AA";
    
    //Gestion des relations d'héritage du jeu
    F1 = game.add.group();
    F2 = game.add.group();
    F3 = game.add.group();
    F4 = game.add.group();
    
    P1 = game.add.group();
    P2 = game.add.group();
    P3 = game.add.group();
    P4 = game.add.group();
    
    formes = game.add.group();
    patrons = game.add.group();
    poubelle = game.add.group();
    
    formes.add(F1);
    formes.add(F2);
    formes.add(F3);
    formes.add(F4);
    
    patrons.add(P1);
    patrons.add(P2);
    patrons.add(P3);
    patrons.add(P4);
    
    //Création des Formes du Panier
    
    var forme1 = game.add.sprite(100, 100, 'carre');
    var forme2 = game.add.sprite(100, 250, 'trapeze');
    var forme3 = game.add.sprite(100, 550, 'hexagone');
    var forme4 = game.add.sprite(100, 400, 'triangle');
    
    forme1.inputEnabled = true;
    forme2.inputEnabled = true;
    forme3.inputEnabled = true;
    forme4.inputEnabled = true;
    
    //Coloration aléatoire
    forme1.tint = Math.random() * 0xffffff;
    forme2.tint = Math.random() * 0xffffff;
    forme3.tint = Math.random() * 0xffffff;
    forme4.tint = Math.random() * 0xffffff;
    
    //Création du patron souhaité
    var patron1 = P1.create(900, 210, 'carre');
    var patron2 = P2.create(850, 310, 'trapeze');
    var patron3 = P3.create(700, 210, 'hexagone');
    var patron4 = P4.create(900, 110, 'triangle');
    
    patron1.inputEnabled = true;
    patron2.inputEnabled = true;
    patron3.inputEnabled = true;
    patron4.inputEnabled = true;
    
    patron1.tint = 0xffcc00;
    patron2.tint = 0xffcc00;
    patron3.tint = 0xffcc00;
    patron4.tint = 0xffcc00;
    
    //Donner valeur à la matrice de quantisation du patron donné
    P1.forEach(function(itemPatron) {
        
        for (var i = 0; i < 100; i++) {
            for (var j = 0; j < 100; j++) {
                if(mat1[i][j]==1){
                    matPatron[Math.floor(itemPatron.x+i)][Math.floor(itemPatron.y+j)] = 1;
                }
            }
        }
            
    }, this);
    
    P2.forEach(function(itemPatron) {
        
        for (var i = 0; i < 200; i++) {
            for (var j = 0; j < 100; j++) {
                if(mat2[i][j]==1){
                    matPatron[Math.floor(itemPatron.x+i)][Math.floor(itemPatron.y+j)] = 1;
                }
            }
        }
            
    }, this);
    
    P3.forEach(function(itemPatron) {
        
        for (var i = 0; i < 200; i++) {
            for (var j = 0; j < 200; j++) {
                if(mat3[i][j]==1){
                    matPatron[Math.floor(itemPatron.x+i)][Math.floor(itemPatron.y+j)] = 1;
                }
            }
        }
            
    }, this);
    
    P4.forEach(function(itemPatron) {
        
        for (var i = 0; i < 100; i++) {
            for (var j = 0; j < 100; j++) {
                if(mat4[i][j]==1){
                    matPatron[Math.floor(itemPatron.x+i)][Math.floor(itemPatron.y+j)] = 1;
                }
            }
        }
            
    }, this);
    
    //Évenements de clic sur les formes du panier
    forme1.events.onInputDown.add(addForme1, this);
    forme2.events.onInputDown.add(addForme2, this);
    forme3.events.onInputDown.add(addForme3, this);
    forme4.events.onInputDown.add(addForme4, this);
    
    //Ajouter les boutons de rotation et de poubelle
    var rot = game.add.sprite(900, 550, 'rotation');
    rot.inputEnabled = true;
    rot.events.onInputDown.add(boutonRotation, this);
    
    var poub = game.add.sprite(770, 550, 'poubelle');
    poub.inputEnabled = true;
    poubelle.add(poub);
    
}

//Fonctions pour ajouter les formes à partir du panier
function addForme1(forme1, pointer) {
    nbF1 = nbF1 + 1;
    var tempSprite = F1.create(180*nbF1+100, 100, 'carre');
    tempSprite.tint = Math.random() * 0xffffff;
    tempSprite.inputEnabled = true; //Pointeur activé
    tempSprite.input.enableDrag(false, true); //Mobile (drag)
    tempSprite.input.enableSnap(10, 10, false, true); //Quantisation de 10 pixels
    tempSprite.events.onInputDown.add(interactionForme, this); //mode d'édition après clic
    tempSprite.events.onDragStop.add(finDrag, this); //fin de drag
}

function addForme2(forme2, pointer) {
    nbF2 = nbF2 + 1;
    var tempSprite = F2.create(250*nbF2+100, 250, 'trapeze');
    tempSprite.tint = Math.random() * 0xffffff;
    tempSprite.inputEnabled = true; //Pointeur activé
    tempSprite.input.enableDrag(false, true); //Mobile (drag)
    tempSprite.input.enableSnap(10, 10, false, true); //Quantisation de 10 pixels
    tempSprite.events.onInputDown.add(interactionForme, this); //mode d'édition après clic
    tempSprite.events.onDragStop.add(finDrag, this); //fin de drag
}

function addForme3(forme3, pointer) {
    nbF3 = nbF3 + 1;
    var tempSprite = F3.create(250*nbF3+100, 550, 'hexagone');
    tempSprite.tint = Math.random() * 0xffffff;
    tempSprite.inputEnabled = true;
    tempSprite.input.enableDrag(false, true);
    tempSprite.input.enableSnap(10, 10, false, true);
    tempSprite.events.onInputDown.add(interactionForme, this);
    tempSprite.events.onDragStop.add(finDrag, this);
}

function addForme4(forme4, pointer) {
    nbF4 = nbF4 + 1;
    var tempSprite = F4.create(180*nbF4+100, 400, 'triangle');
    tempSprite.tint = Math.random() * 0xffffff;
    tempSprite.inputEnabled = true;
    tempSprite.input.enableDrag(false, true);
    tempSprite.input.enableSnap(10, 10, false, true);
    tempSprite.events.onInputDown.add(interactionForme, this);
    tempSprite.events.onDragStop.add(finDrag, this);
}

//Modes d'édition (couleurs et rotation)
function interactionForme(tempSprite, pointer) {
    
    if (test == 1){
        tempSprite.angle += 45;
    }
    
}

//Activation ou pas du bouton de rotation
function boutonRotation(rot, pointer) {
    if (test == 0){
        test = 1;
    }
    else if (test == 1){
        test = 0;
    }
}

//Fonction de fin de drag d'une forme (poubelle, rotation et mise à jour de la matrice quantisée de la solution) 
function finDrag(tempSprite, pointer) {

    if((game.input.y>550) && (game.input.y < 670) && (game.input.x > 770) && (game.input.x < 880)){
        if (tempSprite.key == 'carre'){
            nbF1 = nbF1 - 1;
        }
        if (tempSprite.key == 'trapeze'){
            nbF2 = nbF2 - 1;
        }
        if (tempSprite.key == 'hexagone'){
            nbF3 = nbF3 - 1;
        }
        if (tempSprite.key == 'triangle'){
            nbF4 = nbF4 - 1;
        }
        tempSprite.destroy();
    }
    
    if((game.input.y>550) && (game.input.y < 670) && (game.input.x > 900) && (game.input.x < 1010)){
        tempSprite.angle += 45;
    }
    
    for (var i = 0; i < 1200; i++) {
        for (var j = 0; j < 400; j++) {
            matSolution[i][j] = 0;
        }
    }
    
    F1.forEach(function(itemPatron) {
        
        for (var i = 0; i < 100; i++) {
            for (var j = 0; j < 100; j++) {
                if(mat1[i][j]==1){
                    matSolution[Math.floor(itemPatron.x+i*Math.cos(itemPatron.angle*2*3.14159/360)-j*Math.sin(itemPatron.angle*2*3.14159/360))][Math.floor(itemPatron.y+i*Math.sin(itemPatron.angle*2*3.14159/360)+j*Math.cos(itemPatron.angle*2*3.14159/360))] = 1;
                }
            }
        }
            
    }, this);
    
    F2.forEach(function(itemPatron) {
        
        for (var i = 0; i < 200; i++) {
            for (var j = 0; j < 100; j++) {
                if(mat2[i][j]==1){
                    matSolution[Math.floor(itemPatron.x+i*Math.cos(itemPatron.angle*2*3.14159/360)-j*Math.sin(itemPatron.angle*2*3.14159/360))][Math.floor(itemPatron.y+i*Math.sin(itemPatron.angle*2*3.14159/360)+j*Math.cos(itemPatron.angle*2*3.14159/360))] = 1;
                }
            }
        }
            
    }, this);
    
    F3.forEach(function(itemPatron) {
        
        for (var i = 0; i < 200; i++) {
            for (var j = 0; j < 200; j++) {
                if(mat3[i][j]==1){
                    matSolution[Math.floor(itemPatron.x+i*Math.cos(itemPatron.angle*2*3.14159/360)-j*Math.sin(itemPatron.angle*2*3.14159/360))][Math.floor(itemPatron.y+i*Math.sin(itemPatron.angle*2*3.14159/360)+j*Math.cos(itemPatron.angle*2*3.14159/360))] = 1;
                }
            }
        }
            
    }, this);
    
    F4.forEach(function(itemPatron) {
        
        for (var i = 0; i < 100; i++) {
            for (var j = 0; j < 100; j++) {
                if(mat4[i][j]==1){
                    matSolution[Math.floor(itemPatron.x+i*Math.cos(itemPatron.angle*2*3.14159/360)-j*Math.sin(itemPatron.angle*2*3.14159/360))][Math.floor(itemPatron.y+i*Math.sin(itemPatron.angle*2*3.14159/360)+j*Math.cos(itemPatron.angle*2*3.14159/360))] = 1;
                }
            }
        }
            
    }, this);
    
}

//Fonction Update qui tourne chaque instant dans le programme au fond
//Mettre les formes souhaitées en évidence
//Validation de la solution
function update() {
    game.world.bringToTop(formes);
    game.world.bringToTop(poubelle);
    
    valide = 0;
    
    for (var i = 0; i < 1200; i++) {
        for (var j = 0; j < 400; j++) {
            if(matSolution[i][j]!=matPatron[i][j]){
                valide ++;
            }
        }
    }
    
    if(valide<500){
        fin = 1;
        if (nbAlert == 0){
            nbAlert = 1;
            var delay=500;
            setTimeout(function(){
                alert("Bravo! Vous avez réussi ce niveau!");
            }, delay); 
        }
    }
    
}

//Mode de débougage
function render() {
    game.debug.style = '#fff';
    game.debug.text('Cliquez sur un élément pour créer des nouvelles formes', 16, 24);
    game.debug.text('Carrés : ' + nbF1, 16, 48);
    game.debug.text('Trapèzes : ' + nbF2, 16, 60);
    game.debug.text('Hexagones : ' + nbF3, 16, 72);
    game.debug.text('Triangles : ' + nbF4, 16, 84);
    game.debug.text('Fonction : ' + test, 16, 96);
    game.debug.text('Fin : ' + fin, 16, 108);
    //game.debug.text('MatPatron : ' + matPatron[180][22], 16, 120);
    //game.debug.text('MatSolution : ' + matSolution[180][22], 16, 132);
    //game.debug.inputInfo(16, 144);
}

</script>

</body>
</html>